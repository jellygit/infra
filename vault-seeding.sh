#!/bin/bash

# ==============================================================================
# [Vault Integrated Seeding Script]
# - ëª©ì : Vault KV ì—”ì§„ì— í•„ìš”í•œ ëª¨ë“  ì´ˆê¸° ë°ì´í„°(í™˜ê²½ë³€ìˆ˜, ì¸ì¦ì„œ)ë¥¼ ì¼ê´„ ì£¼ì…
# - ëŒ€ìƒ 1: secret/data/infra/env (í™˜ê²½ë³€ìˆ˜)
# - ëŒ€ìƒ 2: secret/data/certs/wildcard-infra (ì¸ì¦ì„œ)
# - ì „ì œ ì¡°ê±´: vault login ì™„ë£Œ ìƒíƒœ, ./certs í´ë”ì— ì¸ì¦ì„œ ì¡´ì¬
# ==============================================================================

# Vault ì£¼ì†Œ ì„¤ì • (í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
export VAULT_ADDR="https://vlt.infra.lan:8200"
# TLS ê²€ì¦ ë¬´ì‹œ (ì‚¬ì„¤ ì¸ì¦ì„œì¸ ê²½ìš°)
export VAULT_SKIP_VERIFY="true"

# ì¸ì¦ì„œ íŒŒì¼ ê²½ë¡œ ì •ì˜
CERT_FILE="./certs/vault.crt"
KEY_FILE="./certs/vault.key"

# ------------------------------------------------------------------------------
# 1. ì‚¬ì „ ì ê²€
# ------------------------------------------------------------------------------
echo ">>> [1/4] ì‚¬ì „ ì ê²€ (Vault ìƒíƒœ ë° íŒŒì¼ í™•ì¸)..."

if ! vault status >/dev/null 2>&1; then
  echo "âŒ ERROR: Vaultì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. VAULT_ADDR ë° í† í°ì„ í™•ì¸í•˜ì„¸ìš”."
  echo "   Tip: 'vault login'ì„ ë¨¼ì € ì‹¤í–‰í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
  exit 1
fi

if [ ! -f "$CERT_FILE" ] || [ ! -f "$KEY_FILE" ]; then
  echo "âŒ ERROR: ì¸ì¦ì„œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  echo "   ê²½ë¡œ í™•ì¸: $CERT_FILE, $KEY_FILE"
  echo "   Tip: 'site.yml'ì„ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ì„¸ìš”."
  exit 1
fi

echo "âœ… Vault ì—°ê²° í™•ì¸ë¨."
echo "âœ… ì¸ì¦ì„œ íŒŒì¼ í™•ì¸ë¨."

# ------------------------------------------------------------------------------
# 2. KV ì—”ì§„ í™œì„±í™” í™•ì¸
# ------------------------------------------------------------------------------
echo ">>> [2/4] KV ì—”ì§„(secret/) í™œì„±í™” í™•ì¸..."
# ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ëœ¨ì§€ë§Œ ë¬´ì‹œí•˜ê³  ì§„í–‰ (|| true)
vault secrets enable -path=secret kv-v2 2>/dev/null || true

# ------------------------------------------------------------------------------
# 3. ì¸ì¦ì„œ ì—…ë¡œë“œ (secret/certs/wildcard-infra)
# ------------------------------------------------------------------------------
echo ">>> [3/4] ì¸ì¦ì„œ ì—…ë¡œë“œ (secret/certs/wildcard-infra)..."

# @ì‹¬ë³¼ì„ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ë‚´ìš©ì„ ì§ì ‘ ì „ì†¡
vault kv put secret/certs/wildcard-infra \
  cert=@$CERT_FILE \
  key=@$KEY_FILE

if [ $? -eq 0 ]; then
  echo "âœ… ì„±ê³µ: ì¸ì¦ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
else
  echo "âŒ ì‹¤íŒ¨: ì¸ì¦ì„œ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ."
  exit 1
fi

# ------------------------------------------------------------------------------
# 4. í™˜ê²½ë³€ìˆ˜ ì—…ë¡œë“œ (secret/infra/env)
# ------------------------------------------------------------------------------
# ...
echo ">>> [4/4] í™˜ê²½ë³€ìˆ˜ ë°ì´í„° ì£¼ì… (secret/infra/env)..."

# Generate a strong secret key (50+ chars)
GENERATED_SECRET_KEY=$(openssl rand -hex 50)

# ì£¼ì˜: ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” '0000' ëŒ€ì‹  ê°•ë ¥í•œ ë‚œìˆ˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
vault kv put secret/infra/env \
  DB_ROOT_PASS='DBPASSWD' \
  POSTGRES_PASSWORD='PGPASSWORD' \
  DB_HOST='postgres' \
  DB_NAME='netbox' \
  DB_USER='netbox' \
  DB_PASSWORD='NETBOX_PASSWD' \
  REDIS_HOST='redis' \
  REDIS_PORT='6379' \
  SECRET_KEY="$GENERATED_SECRET_KEY" \
  ALLOWED_HOSTS='*' \



if [ $? -eq 0 ]; then
  echo "âœ… ì„±ê³µ: í™˜ê²½ë³€ìˆ˜ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
  echo "----------------------------------------------------------------"
  echo "ğŸ‰ ëª¨ë“  ì‹œë”© ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
  echo "   - ì¸ì¦ì„œ í™•ì¸: vault kv get secret/certs/wildcard-infra"
  echo "   - ë³€ìˆ˜ í™•ì¸:   vault kv get secret/infra/env"
else
  echo "âŒ ì‹¤íŒ¨: í™˜ê²½ë³€ìˆ˜ ì£¼ì… ì¤‘ ì˜¤ë¥˜ ë°œìƒ."
  exit 1
fi
