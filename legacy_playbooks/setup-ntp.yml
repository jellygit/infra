---
- name: Adaptive Time Sync (Kernel Module & PTP Support)
  hosts: all
  become: yes
  vars:
    ntp1: "{{ infra_ntp.server_1 | default('192.168.122.1') }}"
    #ntp2: "{{ infra_ntp.server_2 | default('192.168.10.12') }}"

  tasks:
    # -------------------------------------------------------
    # 1. KVM 전용 커널 모듈 설정 (Persistent)
    # -------------------------------------------------------
    - name: Load ptp_kvm module for KVM guests
      block:
        - name: Ensure ptp_kvm is loaded now
          modprobe:
            name: ptp_kvm
            state: present

        - name: Ensure ptp_kvm loads on boot
          copy:
            dest: /etc/modules-load.d/ptp_kvm.conf
            content: "ptp_kvm"
            owner: root
            group: root
            mode: '0644'
      when: 
        - ansible_facts['virtualization_role'] == "guest"
        - ansible_facts['virtualization_type'] == "kvm"

    # -------------------------------------------------------
    # 2. 패키지 설치 및 장치 확인
    # -------------------------------------------------------
    - name: Install Time Sync Packages
      dnf:
        name:
          - chrony
          - "{{ 'linuxptp' if ansible_facts['virtualization_role'] == 'guest' else omit }}"
        state: present

    - name: Re-collect facts to detect /dev/ptp0
      stat:
        path: /dev/ptp0
      register: ptp_device

    # -------------------------------------------------------
    # 3. SELinux & Chrony 설정 (기존 로직 유지)
    # -------------------------------------------------------
    - name: Allow Chrony to access PTP device (SELinux)
      shell: |
        semanage fcontext -a -t chronyd_var_lib_t "/dev/ptp0" || true
        restorecon -v /dev/ptp0
      when: ptp_device.stat.exists
      failed_when: false

    - name: Configure Chrony
      copy:
        dest: /etc/chrony.conf
        content: |
          {% if ptp_device.stat.exists %}
          # PTP Hardware Clock (KVM/VMware Optimized)
          refclock PHC /dev/ptp0 poll 2 dpoll -2 offset 0 stratum 1 precision 1e-9
          {% endif %}
          
          server {{ ntp1 }} iburst

          driftfile /var/lib/chrony/drift
          makestep 0.1 3
          rtcsync
          
          {% if ansible_facts['virtualization_role'] == "guest" %}
          maxupdateskew 100.0
          {% endif %}

          port 0
          cmdallow 127.0.0.1
          bindcmdaddress 127.0.0.1
      notify: Restart Chronyd

    - name: Ensure Chronyd is Enabled
      service:
        name: chronyd
        state: started
        enabled: yes

  handlers:
    - name: Restart Chronyd
      service:
        name: chronyd
        state: restarted
