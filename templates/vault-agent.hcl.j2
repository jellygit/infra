# [FIX] 권한 문제 해결: vault 계정이 쓰기 가능한 경로로 변경
pid_file = "/etc/vault.d/vault-agent.pid"

vault {
  address = "{{ vault_addr }}"
  # setup-infra-base.yml에서 배포한 CA 인증서 사용
  ca_cert = "/etc/pki/ca-trust/source/anchors/internal-ca.crt"
}

auto_auth {
  method "approle" {
    config = {
      role_id_file_path = "/etc/vault.d/role_id"
      secret_id_file_path = "/etc/vault.d/secret_id"
      remove_secret_id_file_after_reading = false
    }
  }

  sink "file" {
    config = {
      path = "/etc/vault.d/agent-token"
    }
  }
}

# ---------------------------------------------------------------------
# [Template 1] HTTPS 인증서 (Wildcard *.infra.lan)
# ---------------------------------------------------------------------
# [FIX] Ansible Jinja2가 해석하지 않도록 raw 블록으로 감싸줍니다.
{% raw %}
template {
  destination = "/etc/vault.d/generated/certs/fullchain.pem"
  perms = "0644"
  contents = <<EOH
{{- with secret "secret/data/certs/wildcard-infra" -}}
{{ .Data.data.cert }}
{{- end -}}
EOH
}

template {
  destination = "/etc/vault.d/generated/certs/privkey.pem"
  perms = "0640"
  contents = <<EOH
{{- with secret "secret/data/certs/wildcard-infra" -}}
{{ .Data.data.key }}
{{- end -}}
EOH
}

# ---------------------------------------------------------------------
# [Template 2] 통합 환경변수 파일 (.env)
# ---------------------------------------------------------------------
template {
  destination = "/etc/vault.d/generated/infra.env"
  perms = "0640"
  contents = <<EOH
{{ with secret "secret/data/infra/env" }}
# PostgreSQL Common
POSTGRES_USER=postgres
POSTGRES_PASSWORD='{{ .Data.data.DB_ROOT_PASS }}'
DB_HOST=postgres

# NetBox
DB_NAME=netbox
DB_USER=netbox
DB_PASSWORD='{{ .Data.data.DB_PASSWORD }}'
REDIS_HOST=redis
REDIS_PORT=6379
SECRET_KEY='{{ .Data.data.SECRET_KEY }}'
ALLOWED_HOSTS='*'
CSRF_TRUSTED_ORIGINS='https://netbox.infra.lan'

# Semaphore
SEMAPHORE_DB_USER=semaphore
SEMAPHORE_DB_PASS='{{ .Data.data.SEMAPHORE_DB_PASS }}'
SEMAPHORE_DB_NAME=semaphore
SEMAPHORE_ADMIN_email='admin@infra.lan'
{{ end }}
EOH
}
{% endraw %}
